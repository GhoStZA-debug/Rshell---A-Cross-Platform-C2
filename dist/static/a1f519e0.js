import{_ as Ce}from"./f5f6aa45.js";/* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        */import"./4ed993c7.js";/* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        */import{H as Se,aB as ke,r as d,e as z,d as ze,Z as Pe,l as _,m as v,V as l,P as a,p as o,T as i,U as c,a9 as Ee,O as V,S as P,J as De,az as Ve,aA as Ie}from"./95bbca75.js";import{C as ee}from"./59206fab.js";import{a as m,b as Be,v as Te,z as Me,x as Ue,N as $e,f as Le,h as Fe,i as je,ai as Re,J as Ke,aH as Ae,K as Ze,am as Je,an as Oe,aI as qe,aF as He,w as Ge,aJ as Qe,aK as We,aE as Xe,aL as Ye}from"./3325456c.js";const u=E=>(Ve("data-v-3172c8f2"),E=E(),Ie(),E),et={class:"downloads-container"},tt={class:"header-content"},ot=u(()=>o("div",{class:"header-left"},[o("h2",{class:"header-title"},[o("i",{class:"el-icon-download"}),i(" 下载文件管理 ")]),o("p",{class:"header-description"}," 管理从目标主机下载的文件 ")],-1)),lt={class:"header-right"},at=u(()=>o("i",{class:"el-icon-refresh"},null,-1)),nt={class:"table-header"},st={class:"table-title"},it=u(()=>o("i",{class:"el-icon-files"},null,-1)),ct=u(()=>o("span",null,"下载文件列表",-1)),dt={class:"table-actions"},rt=u(()=>o("i",{class:"el-icon-search"},null,-1)),ut=u(()=>o("i",{class:"el-icon-sort"},null,-1)),_t=u(()=>o("i",{class:"el-icon-arrow-down el-icon--right"},null,-1)),mt={key:1},pt={class:"file-name-cell"},ft={class:"file-icon"},ht={class:"file-info"},vt={class:"file-name"},wt={class:"name-text"},gt={key:0,class:"file-format"},bt={class:"file-path"},yt=u(()=>o("i",{class:"el-icon-folder-opened"},null,-1)),Nt={class:"file-size"},xt={class:"progress-cell"},Ct={key:0,class:"progress-time"},St={class:"action-buttons"},kt=u(()=>o("i",{class:"el-icon-download"},null,-1)),zt={class:"stats-info"},Pt={class:"stat-item"},Et=u(()=>o("span",{class:"stat-label"},"文件总数：",-1)),Dt={class:"stat-value"},Vt={class:"stat-item"},It=u(()=>o("span",{class:"stat-label"},"已完成：",-1)),Bt={class:"stat-value success"},Tt={class:"stat-item"},Mt=u(()=>o("span",{class:"stat-label"},"进行中：",-1)),Ut={class:"stat-value warning"},$t={class:"preview-content"},Lt={key:0,class:"preview-loading"},Ft={key:1,class:"preview-text"},jt={key:2,class:"preview-image"},Rt={key:3,class:"preview-not-supported"},Kt=u(()=>o("i",{class:"el-icon-document"},null,-1)),At=u(()=>o("p",null,"暂不支持预览此文件类型",-1)),Zt=u(()=>o("p",null,"请下载后查看",-1)),Jt=[Kt,At,Zt],Ot={class:"batch-dialog-content"},qt={class:"batch-file-list"},Ht={class:"batch-actions"},Gt=Se({__name:"ClientDownloads",setup(E){const te=ke(),w=d([]),N=d(!1),oe=d(),g=d(""),x=d(""),k=d([]),F=d(!1),j=d(!1),le=d(!1),R=d(""),K=d(""),I=d(null),f=d(null),D=d(!1),A=d(!0),B=d(!1),Z=te.query.uid,T=z(()=>{let e=w.value;if(g.value){const t=g.value.toLowerCase();e=e.filter(n=>n.fileName.toLowerCase().includes(t)||n.filePath.toLowerCase().includes(t))}return x.value&&(e=[...e].sort((t,n)=>{switch(x.value){case"name_asc":return t.fileName.localeCompare(n.fileName);case"name_desc":return n.fileName.localeCompare(t.fileName);case"size_asc":return(t.fileSize||0)-(n.fileSize||0);case"size_desc":return(n.fileSize||0)-(t.fileSize||0);case"progress_asc":return(Number(t.downloadPart)||0)-(Number(n.downloadPart)||0);case"progress_desc":return(Number(n.downloadPart)||0)-(Number(t.downloadPart)||0);default:return 0}})),e}),ae=z(()=>w.value.filter(e=>Number(e.downloadPart)===100).length),ne=z(()=>w.value.filter(e=>Number(e.downloadPart)<100).length);z(()=>w.value.reduce((e,t)=>e+(t.fileSize||0),0));const se=z(()=>k.value.reduce((e,t)=>e+(t.fileSize||0),0)),ie=e=>{var p;if(!e)return"el-icon-document";const t=(p=e.split(".").pop())==null?void 0:p.toLowerCase();return{txt:"el-icon-document",md:"el-icon-document",log:"el-icon-document",ini:"el-icon-document",cfg:"el-icon-document",conf:"el-icon-document",js:"el-icon-document",ts:"el-icon-document",html:"el-icon-document",css:"el-icon-document",py:"el-icon-document",java:"el-icon-document",cpp:"el-icon-document",go:"el-icon-document",php:"el-icon-document",sql:"el-icon-document",xml:"el-icon-document",json:"el-icon-document",jpg:"el-icon-picture",jpeg:"el-icon-picture",png:"el-icon-picture",gif:"el-icon-picture",bmp:"el-icon-picture",svg:"el-icon-picture",zip:"el-icon-folder",rar:"el-icon-folder","7z":"el-icon-folder",tar:"el-icon-folder",gz:"el-icon-folder",exe:"el-icon-cpu",msi:"el-icon-cpu",bat:"el-icon-cpu",sh:"el-icon-cpu",bin:"el-icon-cpu",pdf:"el-icon-document",doc:"el-icon-document",docx:"el-icon-document",xls:"el-icon-document",xlsx:"el-icon-document",ppt:"el-icon-document",pptx:"el-icon-document"}[t||""]||"el-icon-document"},M=e=>{var n;return e&&((n=e.split(".").pop())==null?void 0:n.toUpperCase())||""},U=e=>{if(e===0)return"0 B";const t=1024,n=["B","KB","MB","GB","TB"],p=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,p)).toFixed(2))+" "+n[p]},ce=e=>new Date(e).toLocaleString(),de=e=>e===100?"success":e>=75?"warning":e>=50?"":(e>=25,"exception"),re=e=>{if(Number(e.downloadPart)>=100)return"已完成";if(!e.fileSize||!e.downloadSpeed)return"计算中...";const n=e.fileSize*(1-Number(e.downloadPart)/100)/e.downloadSpeed;return n>3600?`${Math.ceil(n/3600)}小时`:n>60?`${Math.ceil(n/60)}分钟`:`${Math.ceil(n)}秒`},J=async()=>{var e;try{const t=await ee.get_downloads_info({uid:Z});((e=t.data)==null?void 0:e.status)===200&&(w.value=(t.data.data||[]).map(n=>({...n,downloading:!1})))}catch(t){console.error("获取下载信息失败:",t),N.value||m.error("获取下载信息失败")}},O=async()=>{N.value=!0,await J(),N.value=!1,m.success("列表已刷新")},q=async e=>{if(Number(e.downloadPart)<100){m.warning("文件尚未下载完成，请等待");return}try{await Be.confirm(`是否下载文件 "${e.fileName}"？`,"下载确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),e.downloading=!0,m.info("开始下载文件...");const t=await ee.download_downloaded_file({uid:Z,filePath:e.filePath});if(t.status===200){let n=e.fileName;const p=t.headers["content-disposition"]||"",C=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(p);C&&C.length>1&&(n=decodeURIComponent(C[1].replace(/['"]/g,"")));const $=new Blob([t.data],{type:t.headers["content-type"]||"application/octet-stream"}),h=window.URL.createObjectURL($),b=document.createElement("a");b.href=h,b.download=n,document.body.appendChild(b),b.click(),document.body.removeChild(b),window.URL.revokeObjectURL(h),m.success("文件下载成功")}else m.error("下载失败，请稍后重试")}catch(t){t!=="cancel"?(console.error("下载失败:",t),m.error(`下载失败: ${t.message||"未知错误"}`)):m.info("已取消下载")}finally{e.downloading=!1}},ue=e=>{k.value=e},_e=e=>{x.value=e},me=({column:e,prop:t,order:n})=>{n==="ascending"?x.value=`${t}_asc`:n==="descending"?x.value=`${t}_desc`:x.value=""},pe=async()=>{B.value=!0;try{for(const e of k.value)Number(e.downloadPart)===100&&(await q(e),await new Promise(t=>setTimeout(t,100)));D.value=!1,m.success("批量下载完成")}catch(e){console.error("批量下载失败:",e),m.error("批量下载失败")}finally{B.value=!1}},fe=()=>{m.info(`找到 ${T.value.length} 个文件`)};return ze(async()=>{await O();const e=setInterval(J,2e3);Pe(()=>{clearInterval(e)})}),(e,t)=>{var W,X;const n=Te,p=Me,C=Ue,$=$e,h=Le,b=Fe,he=je,ve=Re,y=Ke,H=Ae,G=Ze,Q=Je,we=Oe,ge=qe,be=He,L=Ge,S=Qe,ye=We,Ne=Xe,xe=Ye;return _(),v("div",et,[l(p,{shadow:"never",class:"header-card"},{default:a(()=>[o("div",tt,[ot,o("div",lt,[l(n,{type:"primary",onClick:O,loading:N.value,class:"refresh-btn"},{default:a(()=>[at,i(" 刷新列表 ")]),_:1},8,["loading"])])])]),_:1}),l(p,{shadow:"never",class:"table-card"},{header:a(()=>[o("div",nt,[o("div",st,[it,ct,l(C,{size:"small",type:"info",class:"count-tag"},{default:a(()=>[i(c(w.value.length)+" 个文件 ",1)]),_:1})]),o("div",dt,[l($,{modelValue:g.value,"onUpdate:modelValue":t[0]||(t[0]=s=>g.value=s),placeholder:"搜索文件名或路径...",clearable:"",size:"small",style:{width:"200px","margin-right":"10px"},onKeyup:Ee(fe,["enter"])},{prefix:a(()=>[rt]),_:1},8,["modelValue","onKeyup"]),l(he,{onCommand:_e},{dropdown:a(()=>[l(b,null,{default:a(()=>[l(h,{command:"name_asc"},{default:a(()=>[i("文件名 A-Z")]),_:1}),l(h,{command:"name_desc"},{default:a(()=>[i("文件名 Z-A")]),_:1}),l(h,{command:"size_asc"},{default:a(()=>[i("文件大小 ↑")]),_:1}),l(h,{command:"size_desc"},{default:a(()=>[i("文件大小 ↓")]),_:1}),l(h,{command:"progress_asc"},{default:a(()=>[i("进度 ↑")]),_:1}),l(h,{command:"progress_desc"},{default:a(()=>[i("进度 ↓")]),_:1})]),_:1})]),default:a(()=>[l(n,{size:"small"},{default:a(()=>[ut,i(" 排序 "),_t]),_:1})]),_:1})])])]),default:a(()=>[T.value.length===0&&!N.value?(_(),V(ve,{key:0,description:g.value?"未找到相关文件":"暂无下载文件","image-size":100},{default:a(()=>[g.value?(_(),V(n,{key:0,onClick:t[1]||(t[1]=s=>g.value="")},{default:a(()=>[i("清空搜索")]),_:1})):P("",!0)]),_:1},8,["description"])):(_(),v("div",mt,[l(G,{ref_key:"tableRef",ref:oe,data:T.value,loading:N.value,style:{width:"100%"},class:"downloads-table",stripe:"",onSelectionChange:ue,onSortChange:me},{default:a(()=>[l(y,{prop:"fileName",label:"文件名",width:"300",sortable:"custom"},{default:a(({row:s})=>[o("div",pt,[o("div",ft,[o("i",{class:De(ie(s.fileName))},null,2)]),o("div",ht,[o("div",vt,[o("span",wt,c(s.fileName),1),s.downloadPart===100?(_(),V(C,{key:0,size:"mini",type:"success",effect:"plain",class:"complete-tag"},{default:a(()=>[i(" 已完成 ")]),_:1})):P("",!0)]),M(s.fileName)?(_(),v("div",gt,c(M(s.fileName)),1)):P("",!0)])])]),_:1}),l(y,{prop:"filePath",label:"文件路径","min-width":"250","show-overflow-tooltip":""},{default:a(({row:s})=>[o("span",bt,[yt,i(" "+c(s.filePath),1)])]),_:1}),l(y,{prop:"fileSize",label:"文件大小",width:"120",sortable:"custom"},{default:a(({row:s})=>[o("span",Nt,c(s.fileSize),1)]),_:1}),l(y,{prop:"downloadPart",label:"下载进度",width:"200",sortable:"custom"},{default:a(({row:s})=>[o("div",xt,[l(H,{percentage:Number(s.downloadPart),"show-text":!0,status:de(Number(s.downloadPart)),"stroke-width":8},null,8,["percentage","status"]),Number(s.downloadPart)<100?(_(),v("div",Ct," 估计剩余："+c(re(s)),1)):P("",!0)])]),_:1}),l(y,{label:"操作",width:"180",fixed:"right"},{default:a(({row:s})=>[o("div",St,[l(n,{type:"primary",size:"small",onClick:r=>q(s),disabled:Number(s.downloadPart)<100,loading:s.downloading,class:"download-btn"},{default:a(()=>[kt,i(" "+c(Number(s.downloadPart)===100?"下载":"等待完成"),1)]),_:2},1032,["onClick","disabled","loading"])])]),_:1})]),_:1},8,["data","loading"]),o("div",zt,[l(we,null,{default:a(()=>[o("span",Pt,[Et,o("span",Dt,c(w.value.length),1)]),l(Q,{direction:"vertical"}),o("span",Vt,[It,o("span",Bt,c(ae.value),1)]),l(Q,{direction:"vertical"}),o("span",Tt,[Mt,o("span",Ut,c(ne.value),1)])]),_:1})])]))]),_:1}),l(L,{modelValue:F.value,"onUpdate:modelValue":t[2]||(t[2]=s=>F.value=s),title:`预览文件 - ${(W=I.value)==null?void 0:W.fileName}`,width:"80%",top:"5vh"},{default:a(()=>[o("div",$t,[le.value?(_(),v("div",Lt,[l(ge,{rows:5,animated:""})])):R.value?(_(),v("div",Ft,[o("pre",null,c(R.value),1)])):I.value&&I.value.fileName.match(/\.(jpg|jpeg|png|gif|bmp)$/i)?(_(),v("div",jt,[l(be,{src:K.value,fit:"contain","preview-src-list":[K.value]},null,8,["src","preview-src-list"])])):(_(),v("div",Rt,Jt))])]),_:1},8,["modelValue","title"]),l(L,{modelValue:j.value,"onUpdate:modelValue":t[3]||(t[3]=s=>j.value=s),title:`文件信息 - ${(X=f.value)==null?void 0:X.fileName}`,width:"500px"},{default:a(()=>[l(ye,{column:1,border:""},{default:a(()=>{var s;return[l(S,{label:"文件名"},{default:a(()=>{var r;return[i(c((r=f.value)==null?void 0:r.fileName),1)]}),_:1}),l(S,{label:"完整路径"},{default:a(()=>{var r;return[i(c((r=f.value)==null?void 0:r.filePath),1)]}),_:1}),l(S,{label:"文件大小"},{default:a(()=>{var r;return[i(c(U((r=f.value)==null?void 0:r.fileSize)),1)]}),_:1}),l(S,{label:"下载进度"},{default:a(()=>{var r,Y;return[l(H,{percentage:Number((r=f.value)==null?void 0:r.downloadPart),"show-text":!1},null,8,["percentage"]),i(" "+c(Number((Y=f.value)==null?void 0:Y.downloadPart))+"% ",1)]}),_:1}),l(S,{label:"文件类型"},{default:a(()=>{var r;return[i(c(M((r=f.value)==null?void 0:r.fileName)||"未知"),1)]}),_:1}),(s=f.value)!=null&&s.createTime?(_(),V(S,{key:0,label:"创建时间"},{default:a(()=>[i(c(ce(f.value.createTime)),1)]),_:1})):P("",!0)]}),_:1})]),_:1},8,["modelValue","title"]),l(L,{modelValue:D.value,"onUpdate:modelValue":t[6]||(t[6]=s=>D.value=s),title:"批量下载确认",width:"500px"},{footer:a(()=>[l(n,{onClick:t[5]||(t[5]=s=>D.value=!1)},{default:a(()=>[i("取消")]),_:1}),l(n,{type:"primary",onClick:pe,loading:B.value},{default:a(()=>[i(" 开始下载 ")]),_:1},8,["loading"])]),default:a(()=>[o("div",Ot,[l(Ne,{title:"注意",type:"info",closable:!1,"show-icon":""},{default:a(()=>[i(" 将批量下载 "+c(k.value.length)+" 个文件，总计 "+c(U(se.value)),1)]),_:1}),o("div",qt,[l(G,{data:k.value,height:"200"},{default:a(()=>[l(y,{property:"fileName",label:"文件名"}),l(y,{property:"fileSize",label:"大小",width:"100"},{default:a(({row:s})=>[i(c(U(s.fileSize)),1)]),_:1})]),_:1},8,["data"])]),o("div",Ht,[l(xe,{modelValue:A.value,"onUpdate:modelValue":t[4]||(t[4]=s=>A.value=s),label:"压缩为ZIP文件下载"},null,8,["modelValue"])])])]),_:1},8,["modelValue"])])}}});const po=Ce(Gt,[["__scopeId","data-v-3172c8f2"]]);export{po as default};
